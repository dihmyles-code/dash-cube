<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dash Cube+</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
body {
    margin: 0;
    background: #05050a;
    overflow: hidden;
    touch-action: none;
}
canvas {
    width: 100vw;
    height: 55vh;
    display: block;
    margin: auto;
    background: linear-gradient(#0a0a15, #020205);
}
</style>
</head>
<body>

<canvas id="game"></canvas>

<audio id="music" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_8f45d92f3e.mp3" preload="auto"></audio>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const music = document.getElementById("music");

function resize() {
    const dpr = window.devicePixelRatio || 1;
    canvas.width = innerWidth * dpr;
    canvas.height = innerHeight * 0.55 * dpr;
    ctx.setTransform(dpr,0,0,dpr,0,0);
}
resize();
addEventListener("resize", resize);

const groundY = () => canvas.height / (window.devicePixelRatio||1) - 60;

let gravity = 0.8;
let speed = 6;
let score = 0;
let gameOver = false;
let pulse = 0;

const player = {
    x: 120,
    y: groundY()-30,
    size: 30,
    vel: 0,
    rot: 0,
    grounded: false,
    gravityDir: 1
};

let objects = [];

// LEVEL DATA (simple editor replacement)
const level = [
    { t:"spike", x:600 },
    { t:"pad", x:900 },
    { t:"orb", x:1200 },
    { t:"portal", x:1500 },
    { t:"spike", x:1800 },
    { t:"spike", x:2100 },
];

let levelOffset = 0;

function spawnLevel() {
    level.forEach(o=>{
        objects.push({...o, x:o.x+levelOffset});
    });
    levelOffset += 2400;
}
spawnLevel();

function vibrate(ms){ navigator.vibrate && navigator.vibrate(ms); }

function jump(force=false){
    if(gameOver){ reset(); return; }
    if(player.grounded || force){
        player.vel = -12 * player.gravityDir;
        player.grounded = false;
        vibrate(10);
    }
}

document.addEventListener("keydown",e=>{
    if(e.code==="Space") jump();
});
canvas.addEventListener("touchstart",e=>{
    e.preventDefault();
    jump();
},{passive:false});

// Music unlock (iOS requirement)
document.addEventListener("touchstart",()=>{
    music.play().catch(()=>{});
},{once:true});

function reset(){
    objects=[];
    score=0;
    speed=6;
    player.y=groundY()-player.size;
    player.vel=0;
    player.gravityDir=1;
    gameOver=false;
    levelOffset=0;
    spawnLevel();
}

function update(){
    if(gameOver) return;

    pulse = Math.sin(music.currentTime*6)*10;

    player.vel += gravity * player.gravityDir;
    player.y += player.vel;
    player.rot += 0.15;

    if(player.gravityDir===1 && player.y>=groundY()-player.size){
        player.y=groundY()-player.size;
        player.vel=0;
        player.grounded=true;
    }
    if(player.gravityDir===-1 && player.y<=30){
        player.y=30;
        player.vel=0;
        player.grounded=true;
    }

    objects.forEach(o=>o.x-=speed);
    objects=objects.filter(o=>o.x>-100);

    if(objects.length<5) spawnLevel();

    for(const o of objects){
        if(player.x<o.x+30 && player.x+player.size>o.x &&
           player.y<o.y+30 && player.y+player.size>o.y){

            if(o.t==="spike"){ gameOver=true; }
            if(o.t==="pad"){ jump(true); }
            if(o.t==="orb"){ jump(true); }
            if(o.t==="portal"){
                player.gravityDir*=-1;
                vibrate(20);
                o.x=-999;
            }
        }
    }

    score++;
    speed+=0.001;
}

function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    ctx.fillStyle=`rgb(${20+pulse},20,40)`;
    ctx.fillRect(0,0,canvas.width,canvas.height);

    ctx.fillStyle="#00ffff";
    ctx.fillRect(0,groundY(),canvas.width,5);

    ctx.save();
    ctx.translate(player.x+15,player.y+15);
    ctx.rotate(player.rot);
    ctx.fillStyle="#ff00ff";
    ctx.fillRect(-15,-15,30,30);
    ctx.restore();

    objects.forEach(o=>{
        if(o.t==="spike"){
            ctx.fillStyle="#ff3333";
            ctx.beginPath();
            ctx.moveTo(o.x,o.y+30);
            ctx.lineTo(o.x+15,o.y);
            ctx.lineTo(o.x+30,o.y+30);
            ctx.fill();
        }
        if(o.t==="pad"){
            ctx.fillStyle="#00ff00";
            ctx.fillRect(o.x,o.y+20,30,10);
        }
        if(o.t==="orb"){
            ctx.fillStyle="#ffff00";
            ctx.beginPath();
            ctx.arc(o.x+15,o.y+15,10,0,Math.PI*2);
            ctx.fill();
        }
        if(o.t==="portal"){
            ctx.strokeStyle="#00ffff";
            ctx.strokeRect(o.x,o.y,30,40);
        }
    });

    ctx.fillStyle="#fff";
    ctx.font="20px Arial";
    ctx.fillText("Score: "+score,20,30);

    if(gameOver){
        ctx.fillStyle="rgba(0,0,0,.7)";
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle="#00ffff";
        ctx.font="36px Arial";
        ctx.fillText("GAME OVER",canvas.width/2-120,canvas.height/2);
        ctx.font="18px Arial";
        ctx.fillText("Tap / Space to Restart",canvas.width/2-110,canvas.height/2+30);
    }
}

function loop(){
    update();
    draw();
    requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>